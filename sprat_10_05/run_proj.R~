library(Rgadget)
library(tidyverse)

gd <- gadget.variant.dir('/home/valerio/Share/Gadget/test_projections/test_202002/vendace_13.3/vendace01')

btrigger <- 6 ## break point for the harvest control rule
blim <- 4.9 ## break point for the hockey stick recruitment
hrs <- c(0.1,0.2) # seq(0, 0.8, 0.02)
nreps <- 100
ny <- 100
# vd <-  getwd() %>%   #useful for having all operations done in a temporary directory
#   stringr::str_count("/") %>% 
#   rep("../", .) %>% 
#   paste(collapse = "") %>%
#   paste(tempdir(),"_1", sep = "") 
vd <- 'prj'

## fit <- gadget.fit()
fit <- gadget.fit(recruitment_step_age=data.frame(stock="venimm", age=0, step=2))
## recr <- fit$stock.std %>%
##         filter(stock == "venimm" & age == 0 & step == 2) %>%
##         mutate(recruitment = number)
rec <- fit$stock.recruitment
ssb <- fit$res.by.year %>% filter(stock=="venmat") %>% select(year,total.biomass)
tmp <- ssb %>% full_join(rec)
ggplot(tmp) + geom_point(aes(total.biomass,recruitment)) + xlim(0,NA) + ylim(0,NA)

# -----------------------------------------
# hack precision argument for printfile in gadget_project_output
res <- 
      ## gadget_project_time(num_years=100, variant_dir="prj") %>% 
      gadget_project_time(gd,
                          num_years = ny, 
                          variant_dir = vd) %>%
      gadget_project_stocks(imm.file='venimm', mat.file='venmat',
                            spawnfunction="hockeystick",
                            proportionfunction = 'constant 1', ## you will need to change this to something more sensible
                            mortalityfunction = 'constant 0',
                            weightlossfunction = 'constant 0') %>% 
      gadget_project_fleet(pre_fleet='comven2', fleet_type="linearfleet") %>% 
      ## gadget_project_fleets(pre_fleet='sealven', post_fix='prj', fleet_type="totalfleet") %>% 
      gadget_evaluate(params.out = paste(attr(.,'variant_dir'),'params.pre',sep='/'),
                      params.in = 'WGTS/params.final', log = 'prj/log') %>% 
      gadget_project_recruitment(stock = 'venimm',
                                 recruitment = fit$stock.recruitment,
                                 params.file = paste(attr(.,'variant_dir'),'params.pre',sep='/'),
                                 method = "constant",
                                 n_replicates=nreps) %>%
      gadget_project_ref_points(ref_points = tibble(venmat.blim = blim*1e6),
                               params.file = paste(attr(.,'variant_dir'),'params.pre',sep='/')) %>% 
      gadget_project_advice(harvest_rate = hrs,
                            pre_fleet = "comven2",
                            params.file = paste(attr(.,'variant_dir'),'params.pre',sep='/'),
                            n_replicates = nreps,
                            ## advice_cv = 0.2, 
                            post_fix = 'pre') %>%
      gadget_project_output(imm.file='venimm',mat.file='venmat', pre_fleets="comven2") %>%
      gadget_evaluate(params.in = paste(attr(.,'variant_dir'),'params.pre',sep='/')) %>%
      {read.printfiles(paste(attr(.,'variant_dir'),'out',sep='/'))} %>% 
      map(mutate, trial=cut(1:length(year),c(0,which(diff(year)<0),1e9),labels = FALSE)) %>% 
      set_names(c("catch.F","catch.lw",'venimm.rec','venmat.ssb')) %>% 
      ## map(left_join,tibble(trial=1:10000,harvest_rate = rep(1:100/100,each=100)))
      purrr::map(left_join,tibble(trial=1:(length(hrs)*nreps),
                                  harvest_rate = rep(hrs,nreps)))


ggplot(res[[4]]) +
    geom_line(aes(year,number*mean_weight, group=trial, col= as.factor(harvest_rate)))

res[[4]]$biom <- res[[4]]$number * res[[4]]$mean_weight
boxplot(res[[4]]$biom ~ res[[4]]$year)

# -----------------------------------------

yield_curve <- 
 res$catch.lw %>% 
 filter(year>2040) %>% 
 group_by(trial,harvest_rate,year) %>% 
 summarise(c=sum(biomass_consumed)/1e6) %>% 
 group_by(harvest_rate) %>% 
 summarise(m=median(c),u=quantile(c,0.95),l=quantile(c,0.05)) 

ssb_curve <- 
 res$venmat.ssb %>% 
 filter(year>2040) %>% 
 group_by(trial,harvest_rate,year) %>% 
 summarise(c=sum(number*mean_weight)/1e6) %>% 
 group_by(harvest_rate) %>% 
 summarise(m=median(c),u=quantile(c,0.95),l=quantile(c,0.05))

f.curve <- 
 ## res$catch.F %>% 
 res$catch.lw %>% 
 filter(year>2040) %>% 
 group_by(trial,harvest_rate,year) %>% 
 summarise(c=median(mortality)) %>% 
 group_by(harvest_rate) %>% 
 summarise(m=median(c),u=quantile(c,0.95),l=quantile(c,0.05)) 


## Define Blim depending on S-R category
tmp <- fit$res.by.year %>%
       select(stock, year, total.biomass, recruitment) %>%
       mutate(ssb = ifelse(stock=="venimm",NA,total.biomass)) %>%
       select(-c(stock,total.biomass))
tmp <- full_join(na.omit(select(tmp, -ssb)),
                 na.omit(select(tmp, -recruitment)))
ggplot(tmp) +
    geom_text(aes(ssb,recruitment,label=substring(year,3,4)))


# lowest observed ssb
Blim <- 
 fit$res.by.year %>% 
 ## filter(grepl('mat',stock)) %>% 
 filter(stock == 'venmat') %>% 
 summarise(b=min(total.biomass)) %>% 
 .$b

# ssb above average in the low ssb range
Blim <- 
 fit$res.by.year %>% 
 filter(stock == 'venmat' &
        year %in% 2001:2002) %>% 
 summarise(b = mean(total.biomass)) %>% 
 .$b

# set blim manually
Blim <- 4.8*1e6

ggplot(tmp) +
    geom_text(aes(ssb,recruitment,label=substring(year,3,4))) +
    geom_vline(xintercept=Blim)


bpa <- 1.4*Blim  # ***replace 1.4 with appropriate value

hr_msy <- 
 yield_curve %>% filter(m==max(m)) %>% .$harvest_rate

hr_lim <- 
 ssb_curve %>% 
 ## filter(m>Blim) %>% 
 filter(m>Blim/1e6) %>% 
 filter(harvest_rate == max(harvest_rate)) %>% 
 .$harvest_rate


f.msy <-
 f.curve %>% 
 filter(harvest_rate == hr_msy) %>% 
 .$m

f.lim <- f.curve %>% 
         filter(harvest_rate == hr_lim) %>% 
         .$m

f.pa <- f.lim/1.4

hr_pa <- 
 f.curve %>% 
 filter(m < f.pa) %>% 
 summarise(hr = max(harvest_rate)) %>%
 .$hr


library(patchwork)

yield_curve %>% 
 left_join(f.curve %>% 
             select(harvest_rate,F=m)) %>% 
 ggplot(aes(F,m)) +
 geom_ribbon(aes(ymin=l,ymax=u),fill = 'gold') +  
 geom_line() + 
 geom_vline(xintercept = min(c(f.msy,f.pa))) + 
 geom_vline(xintercept = f.pa,lty=2,col='red') + 
 geom_vline(xintercept = f.lim,lwd=1.1,col='red') +
 ssb_curve %>% 
 left_join(f.curve %>% 
             select(harvest_rate,F=m)) %>% 
 ggplot(aes(F,m)) + 
 geom_ribbon(aes(ymin=l,ymax=u),fill = 'gold') + 
 geom_line() + 
 geom_vline(xintercept = min(c(f.msy,f.pa))) + 
 geom_vline(xintercept = f.pa,lty=2,col='red') + 
 geom_vline(xintercept = f.lim,lwd=1.1,col='red') + 
 geom_hline(yintercept = Blim/1e6, col = 'red', lwd = 1.1) + 
 geom_hline(yintercept = bpa/1e6,col = 'red',lty = 2)


